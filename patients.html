<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±Ø¶Ù‰</title>

  <!-- ===== CSS Ø§Ø­ØªØ±Ø§ÙÙŠ ===== -->
  <style>
    body {
      background: #f4f7fb;
      font-family: "Segoe UI", Tahoma, Arial;
      margin: 0;
      padding: 0;
    }

    .page {
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
    }

    .card {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 20px 40px rgba(0,0,0,.08);
      padding: 25px;
      margin-bottom: 30px;
    }

    .card h2 {
      margin-bottom: 20px;
      color: #1e3a8a;
    }

    /* form */
    .form-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .form-row input {
      flex: 1;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid #d1d5db;
      font-size: 14px;
    }

    .form-row button {
      padding: 12px 20px;
      border-radius: 12px;
      background: linear-gradient(135deg, #2563eb, #1e40af);
      color: #fff;
      font-weight: bold;
      border: none;
      cursor: pointer;
    }

    /* table */
    table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 14px;
      overflow: hidden;
    }

    thead {
      background: linear-gradient(135deg, #2563eb, #1e40af);
      color: #fff;
    }

    th, td {
      padding: 12px;
      text-align: center;
      font-size: 14px;
    }

    tbody tr {
      border-bottom: 1px solid #e5e7eb;
    }

    tbody tr:hover {
      background: #f1f5f9;
    }

    td[contenteditable] {
      background: #f9fafb;
      border-radius: 8px;
      outline: none;
    }

    td[contenteditable]:focus {
      background: #e0f2fe;
      box-shadow: inset 0 0 0 2px #2563eb;
    }
  </style>
</head>

<body>

<div class="page">

  <!-- Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙŠØ¶ -->
  <div class="card">
    <h2>â• Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙŠØ¶</h2>
    <form id="patientForm" class="form-row">
      <input id="patientName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶" required>
      <input id="patientFile" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù">
      <button type="submit">Ø¥Ø¶Ø§ÙØ©</button>
    </form>
  </div>

  <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±Ø¶Ù‰ -->
  <div class="card">
    <h2>ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±Ø¶Ù‰</h2>

    <table>
      <thead>
        <tr>
          <th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù„Ø³Ø©</th>
          <th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
          <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
          <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù</th>
          <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø§Øª</th>
          <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
          <th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
          <th>Ù…Ø³Ùƒ Ø§Ù„Ø¬Ù„Ø³Ø©</th>
        </tr>
      </thead>
      <tbody id="patientsTableBody"></tbody>
    </table>
  </div>

</div>

<!-- ===== JS ===== -->
<script type="module">
  import { getCurrentUser, requireAuth } from "./assets/js/auth.js";

  requireAuth();
  const user = getCurrentUser();

  const PATIENTS_KEY = `patients_${user.id}`;
  const TABLE_KEY = `patient_table_${user.id}`;

  const form = document.getElementById("patientForm");
  const nameInput = document.getElementById("patientName");
  const fileInput = document.getElementById("patientFile");
  const tbody = document.getElementById("patientsTableBody");

  let patients = JSON.parse(localStorage.getItem(PATIENTS_KEY)) || [];
  let rows = JSON.parse(localStorage.getItem(TABLE_KEY)) || [];

  function saveAll() {
    localStorage.setItem(PATIENTS_KEY, JSON.stringify(patients));
    localStorage.setItem(TABLE_KEY, JSON.stringify(rows));
  }

  function renderTable() {
    tbody.innerHTML = "";

    rows.forEach(r => {
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${r.name}</td>
        <td contenteditable data-field="sessionType">${r.sessionType}</td>
        <td contenteditable data-field="paidAmount">${r.paidAmount}</td>
        <td contenteditable data-field="remaining">${r.remaining}</td>
        <td>${r.fileNumber}</td>
        <td contenteditable data-field="sessionsCount">${r.sessionsCount}</td>
        <td contenteditable data-field="paymentMethod">${r.paymentMethod}</td>
        <td contenteditable data-field="note">${r.note}</td>
        <td contenteditable data-field="sessionHandler">${r.sessionHandler}</td>
      `;

      tr.querySelectorAll("[contenteditable]").forEach(cell => {
        cell.addEventListener("input", () => {
          const field = cell.dataset.field;
          let value = cell.innerText.trim();
          if (field === "paidAmount" || field === "remaining") {
            value = Number(value) || 0;
          }
          r[field] = value;
          saveAll();
        });
      });

      tbody.appendChild(tr);
    });
  }

  form.addEventListener("submit", e => {
    e.preventDefault();

    const name = nameInput.value.trim();
    const fileNumber = fileInput.value.trim();

    if (!name) return;

    const patient = {
      id: Date.now(),
      name,
      fileNumber
    };

    patients.push(patient);

    rows.push({
      patientId: patient.id,
      name: patient.name,
      fileNumber: patient.fileNumber,
      sessionType: "",
      paidAmount: 0,
      remaining: 0,
      sessionsCount: "",
      paymentMethod: "",
      note: "",
      sessionHandler: ""
    });

    saveAll();
    form.reset();
    renderTable();
  });

  renderTable();
</script>

</body>
</html>
