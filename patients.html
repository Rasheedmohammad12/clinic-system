<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±Ø¶Ù‰</title>

  <style>
    body {
      background: #f4f7fb;
      font-family: "Segoe UI", Tahoma, Arial;
      margin: 0;
      padding: 0;
    }

    .page {
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
    }

    .card {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 20px 40px rgba(0,0,0,.08);
      padding: 25px;
      margin-bottom: 30px;
    }

    .card h2 {
      margin-bottom: 20px;
      color: #1e3a8a;
    }

    .form-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .form-row input {
      flex: 1;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid #d1d5db;
      font-size: 14px;
    }

    .form-row button {
      padding: 12px 20px;
      border-radius: 12px;
      background: linear-gradient(135deg, #2563eb, #1e40af);
      color: #fff;
      font-weight: bold;
      border: none;
      cursor: pointer;
    }

    .search-box {
      margin-bottom: 15px;
      display: flex;
      gap: 10px;
    }

    .search-box input {
      flex: 1;
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid #d1d5db;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 14px;
      overflow: hidden;
    }

    thead {
      background: linear-gradient(135deg, #2563eb, #1e40af);
      color: #fff;
    }

    th, td {
      padding: 12px;
      text-align: center;
      font-size: 14px;
    }

    tbody tr {
      border-bottom: 1px solid #e5e7eb;
    }

    tbody tr:hover {
      background: #f1f5f9;
    }

    .btn-action {
      padding: 6px 10px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 12px;
      margin: 2px;
    }

    .btn-edit { background: #22c55e; color: #fff; }
    .btn-delete { background: #ef4444; color: #fff; }
  </style>
</head>

<body>

<div class="page">

  <!-- Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙŠØ¶ -->
  <div class="card">
    <h2>â• Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙŠØ¶</h2>
    <form id="patientForm" class="form-row">
      <input id="patientName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶" required>
      <input id="patientFile" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù">
      <button type="submit">Ø¥Ø¶Ø§ÙØ©</button>
    </form>
  </div>

  <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±Ø¶Ù‰ -->
  <div class="card">
    <h2>ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±Ø¶Ù‰</h2>

    <!-- ğŸ” Ø§Ù„Ø¨Ø­Ø« -->
    <div class="search-box">
      <input id="searchFile" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù">
    </div>

    <table>
      <thead>
        <tr>
          <th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù„Ø³Ø©</th>
          <th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
          <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
          <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù</th>
          <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø§Øª</th>
          <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
          <th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
          <th>Ù…Ø³Ùƒ Ø§Ù„Ø¬Ù„Ø³Ø©</th>
          <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr>
      </thead>
      <tbody id="patientsTableBody"></tbody>
    </table>
  </div>

</div>

<script src="assets/js/storage.js"></script>

<script type="module">
  import { getCurrentUser, requireAuth } from "./assets/js/auth.js";

  requireAuth();
  const user = getCurrentUser();

  const PATIENTS_KEY = `patients_${user.id}`;
  const TABLE_KEY = `patient_table_${user.id}`;

  const form = document.getElementById("patientForm");
  const nameInput = document.getElementById("patientName");
  const fileInput = document.getElementById("patientFile");
  const tbody = document.getElementById("patientsTableBody");
  const searchInput = document.getElementById("searchFile");

  let patients = JSON.parse(localStorage.getItem(PATIENTS_KEY)) || [];
  let rows = JSON.parse(localStorage.getItem(TABLE_KEY)) || [];

  function saveAll() {
    localStorage.setItem(PATIENTS_KEY, JSON.stringify(patients));
    localStorage.setItem(TABLE_KEY, JSON.stringify(rows));
  }

  function renderTable(filter = "") {
    tbody.innerHTML = "";

    rows
      .filter(r => r.fileNumber.includes(filter))
      .forEach((r, index) => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>${r.name}</td>
          <td contenteditable>${r.sessionType}</td>
          <td contenteditable>${r.paidAmount}</td>
          <td contenteditable>${r.remaining}</td>
          <td>${r.fileNumber}</td>
          <td contenteditable>${r.sessionsCount}</td>
          <td contenteditable>${r.paymentMethod}</td>
          <td contenteditable>${r.note}</td>
          <td contenteditable>${r.sessionHandler}</td>
          <td>
            <button class="btn-action btn-delete">Ø­Ø°Ù</button>
          </td>
        `;

        tr.querySelectorAll("[contenteditable]").forEach((cell, i) => {
          const fields = [
            "sessionType","paidAmount","remaining",
            "sessionsCount","paymentMethod","note","sessionHandler"
          ];
          cell.addEventListener("input", () => {
            r[fields[i]] = cell.innerText.trim();
            saveAll();
          });
        });

        tr.querySelector(".btn-delete").onclick = () => {
          if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ")) return;
          rows.splice(index, 1);
          patients = patients.filter(p => p.id !== r.patientId);
          saveAll();
          renderTable(searchInput.value);
        };

        tbody.appendChild(tr);
      });
  }

  searchInput.addEventListener("input", () => {
    renderTable(searchInput.value.trim());
  });

  form.addEventListener("submit", e => {
    e.preventDefault();

    const name = nameInput.value.trim();
    const fileNumber = fileInput.value.trim();
    if (!name) return;

    const patient = { id: Date.now(), name, fileNumber };
    patients.push(patient);

    addPatient(patient.name, patient.fileNumber);

    rows.push({
      patientId: patient.id,
      name,
      fileNumber,
      sessionType: "",
      paidAmount: 0,
      remaining: 0,
      sessionsCount: "",
      paymentMethod: "",
      note: "",
      sessionHandler: ""
    });

    saveAll();
    form.reset();
    renderTable();
  });

  renderTable();
</script>

</body>
</html>
